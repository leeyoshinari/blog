<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>白瑜的博客</title>
  <link rel="stylesheet" href="/css/main.css">
  <link rel="shortcut icon" href="/img/favicon.ico">
  <script src="/js/jquery.min.js"></script>
  <link rel="stylesheet" href="/css/font/result.css">
</head>
<body>
  <div class="l_body s:aa content tech" id="start" layout="post" >
    <aside class="l_left"></aside>
    <div class="l_main" id="main">
      <header class="header mobile-only"></header>
      <div class="article banner top"><div class="content"><div class="bottom only-title"><div class="text-area">
        <h1 class="text title"><span>Windows 风格的个人网盘</span></h1>
      </div><div class="publish-date"><span>发布时间：2024-02-28</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span>更新时间：2024-07-27</span></div></div></div></div>
      <article class="md-text content">
        <h2 id="写在最前面">写在最前面</h2>
        <p>众所周知，当前使用最广泛的云盘是百度网盘，而百度各种骚操作真让人无法忍受，倍速看视频还要开会员，真是恶心他妈给恶心开门。而号称不限速的阿里云盘也开始限速了，后面可能也和百度一个德行。其实各种体验问题都可以容忍，最无法忍受的是数据安全，我们上传到百度网盘的每一个文件，都已经被备份了 n 份了，尽管有些文件已经被我们删除了，但是这些文件仍然在百度的服务器里，个人隐私极不安全；可能有些人不太清楚，很久之前百度网盘有一个秒传功能，为什么一个几 G 的文件能秒传，那是因为百度的服务器里已经有了一个相同的文件了，你上传的文件其实并不是你的文件，如果你删除了这个文件，其实你也并没有删除这个文件。而且百度还有人工审核（偷窥）用户隐私图片的前科。还有另一个非常严重的问题是自己好不容易收藏的电影，结果变成了 8s 的教育片。</p>
        <p>既然这么多问题，那我就不用你了，那要存储文件怎么办，可以自己部署一个私有云盘呀。目前免费的比较好的私有云盘有: 国外的有 Nextcloud、ownCloud，这两个出自一脉，免费版的基本功能都有，但有一个致命的弱点是慢，非常占用服务器资源，网上一堆提高性能的攻略都没用(可能我水平不行，没有 get 到点)；国内的有可道云，免费版的也是基本功能都有，很多想用的功能都需要收费。于是我就自己写了这个网盘，网盘的前端是在<a href="https://github.com/tjy-gitnub/win12" target="_blank">开源Windows12网页版</a>项目的基础上进行了大量的增删改，后端纯个人开发。</p>
        <p>如果按照后面推荐的部署方案部署该网盘，成本比开百度会员要底很多，且可以保证数据安全。</p>
        <h2 id="功能概览">功能概览</h2>
        <ul>
            <li>文件夹的新建、删除、重命名、移动、导出</li>
            <li>文件的上传、下载、新建、删除、移动、重命名、分享</li>
            <li>支持 OnlyOffice (Word、Excel、PowerPoint) 在线编辑和多人协作</li>
            <li>支持 txt、markdown、xmind脑图、表格、文档的在线编辑功能</li>
            <li>支持 python 脚本在线编辑和运行</li>
            <li>支持远程连接 Linux 服务器</li>
            <li>音乐播放器，支持播放云盘（服务端）和本地（客户端）的音乐</li>
            <li>集成 aria2，支持 HTTP、FTP、BitTorrent 等多种下载协议</li>
            <li>增加游戏中心，支持贪吃蛇、俄罗斯方块游戏（会陆续支持更多小游戏）</li>
            <li>支持多语言，支持配置多语言</li>
            <li>单点登录，不同用户的数据完全隔离</li>
            <li>可任意挂载多个磁盘</li>
        </ul>
        <p>如需体验网盘前端交互，<a href="https://windows.ihuster.top" target="_blank">请点击体验</a>，因为没有后端，只能体验前端交互。</p>
        <h2 id="部署">部署</h2>
        <p>1、克隆项目</p>
        <pre style="margin-left: 2em;"><code>git clone https://github.com/leeyoshinari/OneDrive.git</code></pre>
        <p>2、安装第三方依赖包；</p>
        <pre style="margin-left: 2em;"><code>pip3 install -r requirements.txt -i http://mirrors.aliyun.com/pypi/simple</code></pre>
        <p>3、修改配置文件<code>config.conf</code>；</p>
        <p>4、初始化数据库，依次执行下面命令;</p>
        <pre style="margin-left: 2em;"><code>aerich init -t settings.TORTOISE_ORM<br>aerich init-db</code></pre>
        <p>5、安装文件下载工具 <a href="https://github.com/aria2/aria2/releases" target="_blank">aria2</a>，执行 <code>aria2c -v</code> 验证是否安装成功。</p>
        <p>6、部署<code>nginx</code>，并修改配置，location 相关配置如下：(ps: 下面 location 中的<code>mycloud</code>就是配置文件<code>config.conf</code>中的<code>prefix</code>，可根据自己需要修改)；</p>
        <p>（1）前端配置：前端文件在 <code>web</code> 目录里, <code>/Windows</code>可任意修改成你喜欢的名字</p>
        <pre style="margin-left: 2em;"><code>location /Windows {<br>    alias /home/Windows/web/;<br>    index  index.html;<br>}</code></pre>
        <p>（2）后端请求：<code>proxy_pass</code> 是配置文件 <code>config.conf</code> 中的 IP 和 端口, <code>/mycloud</code> 必须和 <code>config.conf</code> 中的 <code>prefix</code> 一样</p>
        <pre style="margin-left: 2em;"><code>location /mycloud {<br>    proxy_pass  http://127.0.0.1:15200;<br>    proxy_set_header Host $proxy_host;<br>    proxy_set_header lang $http_lang;<br>    proxy_set_header X-Real-IP $remote_addr;<br>    proxy_set_header Upgrade $http_upgrade;<br>    proxy_set_header Connection $proxy_connection;<br>    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;<br>}</code></pre>
        <p>（3）在 <code>http</code> 模块中，需要添加一个映射关系</p>
        <pre style="margin-left: 2em;"><code>map $http_upgrade $proxy_connection {<br>    default upgrade;<br>    "" close;<br>}</code></pre>
        <p>（4）访问 Swagger 接口页面</p>
        <pre style="margin-left: 2em;"><code>location /api/openapi {<br>    proxy_pass  http://127.0.0.1:15200;<br>}</code></pre>
        <p>通常nginx会限制请求体大小，需要增加配置<code>client_max_body_size 4096M;</code>，还有其他超时时间的配置，可自行上网查找资料修改；</p>
        <p>7、启动</p>
        <pre style="margin-left: 2em;"><code>sh startup.sh</code></pre>
        <p>停止请执行 <code>sh shutdown.sh</code></p>
        <p>8、创建用户</p>
        <p>为了避免被其他人恶意创建账号，页面未放开创建账号的入口；可以通过在API接口文档中创建用户，进入 swagger-ui 页面，找到 <code>createUser</code> 接口即可。</p>
        <pre style="margin-left: 2em;"><code>http://IP:Port/mycloud/swagger-ui</code></pre>
        <p>9、访问页面，url 是 <code>http://IP:Port/Windows</code>（这里的 IP 和 端口是 Nginx 中设置的 IP 和 端口。Windows 就是第 6 步中的前端配置的 location）</p>
        <p>10、如果想把当前服务器上已有的文件导入系统中，可访问后台 swagger-ui 接口页面，找到 <code>file/import</code> 接口，请求参数分别是需要导入的文件夹的绝对路径和目标的目录Id。</p>
        <h2 id="功能介绍">功能介绍</h2>
        <p>系统的核心功能就是一个网盘（和百度网盘的功能类似），还提供了比普通网盘更多的功能 —— 文本等文件的在线编辑功能，且可任意扩展功能。在页面上看到的文件和文件夹的目录层级结构在本地服务器/电脑的磁盘里是真实存在的，即使你以后觉得我这个系统不好用了，我也会给你留下一个完整有序的目录文件，而不是乱序的。</p>
        <h3 id="登录页面">登录页面</h3>
        <img src="/img/Windows/login.jpg" alt="" loading="lazy">
        <p>在登陆页面左上角可以切换语言。登录页面的背景图片的路径是<code>web/img/pictures/undefined/background.jpg</code>，如需修改登录背景图片，可直接替换掉这个图片即可，注意：图片名必须是<code>background.jpg</code>；</p>
        <h3 id="页面总概览">页面总概览</h3>
        <p>桌面背景图片可以在<code>设置</code>里更换。</p>
        <img src="/img/Windows/desktop.jpg" alt="">
        <h3 id="文件资源管理器">文件资源管理器</h3>
        <p>上边一排工具栏依次是新建文件、新建文件夹、重命名、移动、复制、上传、下载、分享、删除，这些图标均来源<code>Windows10</code>的系统图标。文件列表可按照名称、创建时间、修改时间排序。文件资源管理器中的所有文件，除了支持在线编辑的文件外，其他格式的文件会直接用浏览器打开，浏览器能打开预览的文件可以直接在浏览器中预览，浏览器不支持预览的文件则直接下载到本地。</p>
        <p>使用文件上传功能上传文件时，会首先检测网盘是否存在相同的文件，如果存在则不上传，这就是类似一些网盘的秒传的功能。</p>
        <img src="/img/Windows/file.jpg" alt="" loading="lazy">
        <h3 id="回收站">回收站</h3>
        <p>上边一排工具栏依次是还原文件、删除文件、清空回收站，基本上和<code>Windows</code>系统的回收站操作一样。</p>
        <img src="/img/Windows/garbage.jpg" alt="" loading="lazy">
        <h3 id="我的分享">我的分享</h3>
        <p>当分享文件时，可设置分享链接的打开次数，超过次数会返回 Nginx 默认页面。其中：markdown、表格、文档 和 xmind 分享链接打开后页面虽然可以编辑，但数据不会保存，仅支持导出数据。</p>
        <p>分享功能的常规使用场景是分享文件给别人，还要一个场景就是去打印店打印文档，通过浏览器调用打印机后，刷新页面到指定的次数，这个链接就失效了，有效降低了文档泄漏的风险和使用U盘被病毒感染的风险。</p>
        <img src="/img/Windows/share.jpg" alt="" loading="lazy">
        <h3 id="设置">设置</h3>
        <p>支持修改密码、退出登陆、上传桌面背景图片、设置主题、窗口透明、选择语言、播放本地视频、ssh。其中上传的桌面背景图片的格式必须是<code>jpg</code>。</p>
        <img src="/img/Windows/setting.jpg" alt="" loading="lazy">
        <h3 id="计算器">计算器</h3>
        <p>一个很鸡肋的小工具，感觉还不如用 python 命令行计算。</p>
        <img src="/img/Windows/calc.jpg" alt="" loading="lazy">
        <h3 id="Whiteboard 画板">Whiteboard 画板</h3>
        <p>没事的时候可以用鼠标涂鸦画画，放松一下。</p>
        <img src="/img/Windows/wihteboard.jpg" alt="" loading="lazy">
        <h3 id="浏览器">浏览器</h3>
        <p>功能简单的浏览器，只支持允许嵌套的网页。经测试，仅支持必应搜索。这里使用的是iframe嵌套的方式，百度和Google搜索不允许 iframe 嵌套，所以用不了；后面可考虑接入后端进行请求转发，解决跨域和嵌套的问题。</p>
        <img src="/img/Windows/edge.jpg" alt="" loading="lazy">
        <h3 id="连接 Linux">连接 Linux</h3>
        <p>在<code>设置</code>里添加服务器，在列表中点击<code>打开</code>即可远程连接 Linux，支持上传和下载文件，支持 <code>Ctrl+C（复制）</code> 和 <code>Ctrl+V（粘贴）</code> 快捷键，同时 <code>Ctrl+C</code> 还保留结束当前进程的功能。为节省服务器资源，对“挂机”超过10分钟的连接进行关闭。</p>
        <img src="/img/Windows/shell1.jpg" alt="" loading="lazy">
        <img src="/img/Windows/shell2.jpg" alt="" loading="lazy">
        <h3 id="播放本地视频">播放本地视频</h3>
        <p>播放本地视频不使用流量，支持记录播放进度；做这个功能的原因是：我的手机上没有安装视频软件，只能用相册自带的功能看视频，但是它记不住播放进度，每次手误碰退出视频，就得重新看，贼麻烦。所以这个功能就是用来记录视频播放进度的。</p>
        <img src="/img/Windows/playVideo.jpg" alt="" loading="lazy">
        <h3 id="音乐播放器">音乐播放器</h3>
        <p>音乐播放器只支持 <code>mp3</code> 格式的歌曲和 <code>.lrc</code> 格式的歌词，如果要展示歌词，需要歌曲名和歌词名一样。只有当一首歌播放进度超过 <code>30%</code> 时，才会被添加到播放历史中；歌曲被添加到历史记录中时，播放次数就会 <code>+1</code>。</p>
        <p>打开音乐播放器的方式和在 windows 上使用一样：</p>
        <p>1、点击桌面音乐播放器的图标，进入音乐播放器界面，然后导入音乐；</p>
        <p>2、进入文件资源管理器，找到<code>mp3</code>格式的歌曲，双击打开即可播放刚打开的歌曲；</p>
        <img src="/img/Windows/music.jpg" alt="" loading="lazy">
        <h3 id="Python 命令行">Python 命令行</h3>
        <p>支持 python 命令行，支持导入 python 官方库，可以用来做一些简单的计算，或者处理一些简单的数据。</p>
        <img src="/img/Windows/python.jpg" alt="" loading="lazy">
        <h3 id="aria2c 下载工具">aria2c 下载工具</h3>
        <p>aria2 是一个轻量级的多协议命令行下载工具，支持 HTTP、FTP、BitTorrent 等多种协议，支持多连接下载和断点续传。</p>
        <p>进入需要下载文件的目录，然后点击 <code>新建文件 -> 新建下载任务</code>，在输入框中填入下载的 URL 即可，如果需要 cookie 才能下载，则需要填入 cookie，否则可以不填 cookie。</p>
        <img src="/img/Windows/download-new.jpg" alt="" loading="lazy">
        <p>如需查看当前正在下载的任务，点击 <code>下载列表</code> 即可。点击<code>暂停</code>可以暂停下载任务，点击<code>取消</code>可以取消下载，下载完成后，即可在目录里看到下载的文件。</p>
        <img src="/img/Windows/download-list.jpg" alt="" loading="lazy">
        <h3 id="游戏中心">游戏中心</h3>
        <p>增加了游戏中心，现支持贪吃蛇、俄罗斯方块游戏，后续会陆续支持其他网页版的小游戏</p>
        <img src="/img/Windows/snake.jpg" alt="" loading="lazy">
        <h3 id="多语言设置">多语言设置</h3>
        <p>目前多语言已支持中文简体和英文，可能存在翻译不正确，或者漏翻译的，请自行修改。</p>
        <p>多语言切换有2个地方：一个地方是登陆页面左上角；另一个地方是 <code>设置->个性化->设置语言</code>。多语言配置分为前端配置和后端配置，前端配置的多语言主要是页面文案展示，后端配置的多语言主要是接口返回信息和日志。</p>
        <p>1、前端多语言配置在 <code>web->language</code> 目录下面，每一种语言对应一个 json 文件，json 文件里对应的是多语言字段的 key 和翻译，如需新增多语言，请先复制一份 json 文件，然后修改翻译，不能修改 key。</p>
        <p>2、后端多语言配置在 <code>common->messages.py</code> 文件中，每一个 message 是一个 dict，dict 中的每一个 key 对应一种多语言，如需新增多语言，可直接新增一对 key-value 即可。</p>
        <h3 id="OnlyOffice">OnlyOffice</h3>
        <p>打开 office 文件，会使用 onlyoffice 打开，可在线编辑并实时保存，关闭窗口可退出编辑，onlyoffice 默认设置是：用户退出编辑 10s 后，才会自动把文件保存到本地。</p>
        <p>多人协作编辑文档：可通过在文件列表中需要协作编辑的文件上右键，获取协作编辑的链接，然后把链接发送给协作编辑的人。如果其中一个用户退出编辑，然后再通过链接进入编辑状态，此时不会协作编辑，必须所有用户全部重新进入编辑状态才可以协作编辑。</p>
        <p>查看历史版本：可从历史记录中查看文档的改动，并可从历史记录中恢复。</p>
        <img src="/img/Windows/word.jpg" alt="" loading="lazy">
        <img src="/img/Windows/excel.jpg" alt="" loading="lazy">
        <img src="/img/Windows/powerpoint.jpg" alt="" loading="lazy">
        <img src="/img/Windows/history.jpg" alt="" loading="lazy">
        <p>OnlyOffice 和 <a href="/p/940241893.html">这个插件</a> 搭配只用效果更好哦 ~</p>
        <h3 id="在线编辑功能">在线编辑功能</h3>
        <p>所有在线编辑功能：每隔10秒自动保存，标题栏文件名旁会展示自动保存的时间，点击关闭按钮也会自动保存。其中<code>txt</code>、<code>markdown</code>和<code>文档</code>的在线编辑支持导出成<code>html</code>格式，用浏览器打开导出的<code>html</code>后，可通过浏览器自带的打印功能把文件转成<code>PDF</code>格式。</p>
        <h4 id="txt 文件">txt 文件</h4>
        <p>点击右上角的下载按钮，可以直接将当前文档转成 html，并下载。如需下载原 txt 文件，可在文件资源管理器中选中文件并点击下载。</p>
        <img src="/img/Windows/txt.jpg" alt="" loading="lazy">
        <h4 id="markdown 文件">markdown 文件</h4>
        <p>点击右上角的下载按钮，可以直接将当前文档转成 html，并在新标签页打开，如需下载这个 html，可在新打开的标签页右键下载。需要注意：这里使用的是第三方工具转的 html，一些样式在转换时会丢失。如需保留所有的 html 样式，可在工具栏点击<code>全窗口预览HTML</code>即可。</p>
        <img src="/img/Windows/markdown.jpg" alt="" loading="lazy">
        <h4 id="表格">表格</h4>
        <p>由于表格功能太多，暂不支持导出功能，可用于在线存储一些数据，可手动复制表格中的数据，并粘贴到本地 excel 表格中。</p>
        <img src="/img/Windows/sheet.jpg" alt="" loading="lazy">
        <h4 id="文档">文档</h4>
        <p>该文档左侧带有目录，支持目录定位页面到指定位置。可导出成 html 格式的文件，用浏览器打开 html 文件，调用浏览器自带的打印功能，调整打印页边距，可把文档转成页面布局合适的 PDF 文件。</p>
        <img src="/img/Windows/docx.jpg" alt="" loading="lazy">
        <h4 id="xmind 脑图">xmind 脑图</h4>
        <p>支持标准的 <code>xmind</code> 文件（<code>xmind8</code> 和 <code>xmind zen(xmind 2020)</code>）在线编辑，文件打开后，原文件格式已经转换，只能通过页面工具栏中的导出功能才能导出 <code>xmind8</code>（只支持导出 <code>xmind8</code>，不支持导出 <code>xmind zen</code>）。在线编辑的脑图中添加的样式、颜色、优先级、完成进度、备注等也支持导出到 <code>xmind8</code> 中。</p>
        <img src="/img/Windows/xmind.jpg" alt="" loading="lazy">
        <h4 id="Python 脚本">Python 脚本</h4>
        <p>支持在线编辑 py 文件，点击运行后可直接在浏览器上看到结果。如果想导入第三方库，需要专门打包，具体可查阅相关资料。</p>
        <img src="/img/Windows/pythonEditor.jpg" alt="" loading="lazy">
        <h2 id="其他">其他</h2>
        <p>1、支持 <code>Linux</code>、<code>Windows</code>、<code>MacOS</code> 等多个平台，建议在 <code>Linux</code> 系统部署；可尝试在国产操作系统上部署，如有问题，欢迎提出。</p>
        <p>2、因为是在操作本地文件，所以不支持集群部署和分布式存储，如果非要集群部署，可通过挂在网络磁盘的方式让集群中的各个节点访问同一个文件夹。</p>
        <p>3、在线播放视频，基本上都是用的是流式播放（边缓存边播放），这就要求视频的元数据必须在视频文件的最前面，而有些视频的元数据在视频文件的末尾，这就需要浏览器把整个视频加载完成后才能播放，体验极差。因此需要手动将视频的元数据移动到视频文件的最前面，然后再上传至云盘，这里使用 <a href="https://github.com/BtbN/FFmpeg-Builds/releases" target="_blank">ffmpeg</a> 工具移动视频的元数据，命令：<code>ffmpeg -i input_video.mp4 -map_metadata 0 -c:v copy -c:a copy -movflags +faststart output_video.mp4</code>。</p>
        <p>4、所有页面和操作已尽可能的适配手机端了，使用手机浏览器打开页面，手机横屏展示，使用体验还是不错的。</p>
        <p>5、更好的使用体验建议：不管你用的是 PC 端浏览器还是手机端浏览器，设置浏览器全屏展示，使用体验更好。</p>
        <h2 id="推荐部署方案">推荐部署方案</h2>
        <p>1、带公网 IP 的云服务器，买云服务器的钱比开百度网盘会员的钱要便宜的多得多，而且有公网 IP，还可以干其他很多有趣的事情；</p>
        <p>2、树莓派，用于部署网盘服务，可根据自己的需求买对应配置的树莓派，500 元左右就可以买一个差不多配置的树莓派了，咸鱼上可能更便宜。树莓派 24h 开机，一个星期的耗电量大约不到 1 度电；高配置的树莓派还可以用来当电脑、电视、机顶盒用哦，就看你的动手能力有多强了；</p>
        <p>3、硬盘，自己可以买一个几T的机械硬盘存储数据，现在机械硬盘也很便宜；土豪可以用固态硬盘，也不是很贵；</p>
        <p>4、内网穿透，在云服务器和树莓派上分别部署内网穿透软件即可，推荐使用 frp 进行内网穿透；</p>
        <hr style="margin-top: 3em;">
        <div class="article-footer fs14"></div>
        </article>
        <footer class="page-footer footnote"><hr></footer>
        <div class="main-mask" onclick="sidebar.dismiss()"></div>
      </div>
      <aside class="l_right"></aside>
    </div>
  </body>
  <script type="module">
    import { createLeft, createFootNote, createMobileHeader, createDonate, createRight, createFloatPanel } from '/js/template.js';
    document.getElementsByClassName('l_left')[0].appendChild(createLeft());
    document.getElementsByClassName('header mobile-only')[0].appendChild(createMobileHeader());
    document.getElementsByClassName('article-footer fs14')[0].appendChild(createDonate());
    document.getElementsByClassName('page-footer footnote')[0].appendChild(createFootNote());
    document.getElementsByClassName('l_right')[0].appendChild(createRight());
    document.getElementById('start').appendChild(createFloatPanel());
  </script>
  <script type="text/javascript" src="/js/main.js"></script>
  </html>